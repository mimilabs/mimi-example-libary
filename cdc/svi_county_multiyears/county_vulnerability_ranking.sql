
/* 
Social Vulnerability Index (SVI) Trend Analysis by County

Business Purpose:
This query analyzes county-level social vulnerability trends over time to help:
- Identify consistently vulnerable areas needing long-term support
- Track effectiveness of intervention programs
- Guide resource allocation for disaster preparedness
- Support policy decisions and funding priorities

Created: 2024-02
*/

-- Main Analysis Query
WITH RankedCounties AS (
  -- Calculate average SVI scores and rank counties
  SELECT 
    state_abbr,
    county_name,
    fips,
    ROUND(AVG(svi), 3) as avg_svi,
    ROUND(AVG(rpl_socioeconomic), 3) as avg_socioeconomic,
    ROUND(AVG(rpl_householdcomp), 3) as avg_household,
    ROUND(AVG(rpl_minoritystatus), 3) as avg_minority,
    ROUND(AVG(rpl_housingtransport), 3) as avg_housing,
    COUNT(DISTINCT year) as years_of_data,
    MIN(year) as first_year,
    MAX(year) as last_year
  FROM mimi_ws_1.cdc.svi_county_multiyears
  GROUP BY state_abbr, county_name, fips
),
HighRiskCounties AS (
  -- Identify counties with consistently high vulnerability
  SELECT *,
    RANK() OVER (ORDER BY avg_svi DESC) as vulnerability_rank
  FROM RankedCounties
  WHERE years_of_data >= 5  -- Only include counties with sufficient historical data
)

SELECT 
  state_abbr,
  county_name,
  avg_svi as overall_vulnerability_score,
  avg_socioeconomic as socioeconomic_score,
  avg_household as household_score,
  avg_minority as minority_score,
  avg_housing as housing_score,
  years_of_data,
  first_year,
  last_year,
  vulnerability_rank
FROM HighRiskCounties
WHERE vulnerability_rank <= 100  -- Focus on top 100 most vulnerable counties
ORDER BY vulnerability_rank;

/*
How This Query Works:
1. Calculates multi-year averages for overall SVI and component scores
2. Ensures data quality by filtering for counties with 5+ years of data
3. Ranks counties by average overall vulnerability
4. Returns detailed vulnerability profile for top 100 highest-risk counties

Assumptions & Limitations:
- Assumes consistent measurement methodology across years
- May not capture recent dramatic changes in vulnerability
- Equal weighting given to all years in the average
- Requires at least 5 years of data for inclusion

Possible Extensions:
1. Add trend analysis to identify rapidly changing vulnerabilities:
   - Calculate year-over-year changes
   - Flag counties with significant vulnerability increases

2. Geographic clustering analysis:
   - Group by state to identify regional patterns
   - Calculate neighboring county statistics

3. Component analysis:
   - Identify which vulnerability factors contribute most to overall score
   - Track changes in specific vulnerability components over time

4. Risk categorization:
   - Create vulnerability categories (High/Medium/Low)
   - Cross-reference with disaster frequency data
*/
/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-10-28T15:43:01.251771
    - Additional Notes: Query focuses on long-term vulnerability patterns by requiring 5+ years of data, which may exclude some counties with incomplete historical records. The top 100 ranking provides a focused view of the most vulnerable areas but can be adjusted based on specific needs. Consider local population size when interpreting results as the analysis treats all counties equally regardless of population.
    
    */