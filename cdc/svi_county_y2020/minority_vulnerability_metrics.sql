-- Title: County-Level Social Vulnerability and Racial Disparities Analysis
-- Business Purpose: Analyze the intersection of social vulnerability and racial/ethnic composition
-- to identify counties where minority communities may face disproportionate social challenges.
-- This information helps healthcare organizations and policymakers target culturally-sensitive
-- interventions and resource allocation.

WITH CountyMetrics AS (
    -- Calculate key vulnerability and demographic metrics at county level
    SELECT 
        state,
        county,
        e_totpop AS total_population,
        rpl_themes AS overall_vulnerability_percentile,
        ep_minrty AS minority_percentage,
        ep_pov150 AS poverty_percentage,
        ep_uninsur AS uninsured_percentage,
        ep_limeng AS limited_english_percentage,
        
        -- Calculate specific racial/ethnic composition percentages
        ep_afam AS black_percentage,
        ep_hisp AS hispanic_percentage,
        ep_asian AS asian_percentage,
        ep_aian AS native_american_percentage
    FROM mimi_ws_1.cdc.svi_county_y2020
    WHERE e_totpop > 0  -- Exclude counties with no population
)

SELECT 
    state,
    county,
    total_population,
    overall_vulnerability_percentile,
    minority_percentage,
    poverty_percentage,
    uninsured_percentage,
    limited_english_percentage,
    
    -- Create demographic profile categories
    CASE 
        WHEN black_percentage >= 25 THEN 'High Black Population'
        WHEN hispanic_percentage >= 25 THEN 'High Hispanic Population'
        WHEN asian_percentage >= 15 THEN 'High Asian Population'
        WHEN native_american_percentage >= 10 THEN 'High Native American Population'
        ELSE 'No Predominant Minority Group'
    END AS demographic_profile,
    
    -- Flag highly vulnerable minority communities
    CASE 
        WHEN overall_vulnerability_percentile >= 0.75 
        AND minority_percentage >= 50 THEN 'High Priority'
        WHEN overall_vulnerability_percentile >= 0.75 
        OR minority_percentage >= 50 THEN 'Medium Priority'
        ELSE 'Lower Priority'
    END AS intervention_priority
FROM CountyMetrics
WHERE overall_vulnerability_percentile >= 0.5  -- Focus on more vulnerable counties
ORDER BY overall_vulnerability_percentile DESC, minority_percentage DESC;

-- How this query works:
-- 1. Creates a CTE with key demographic and vulnerability metrics
-- 2. Calculates demographic profiles based on racial/ethnic composition thresholds
-- 3. Assigns intervention priorities based on combined vulnerability and minority presence
-- 4. Filters to focus on counties with above-median vulnerability
-- 5. Orders results to highlight most vulnerable minority communities first

-- Assumptions and limitations:
-- - Assumes counties with >25% of a specific racial group represent significant presence
-- - Limited to racial/ethnic categories tracked in the SVI dataset
-- - Does not account for intersectionality between different minority groups
-- - Focuses on larger vulnerable populations (may miss smaller but highly vulnerable communities)

-- Possible extensions:
-- 1. Add temporal analysis by comparing with historical SVI data
-- 2. Include healthcare facility density or provider availability metrics
-- 3. Incorporate COVID-19 impact data to assess pandemic vulnerability
-- 4. Add geographic clustering analysis to identify regional patterns
-- 5. Include language-specific service needs based on limited English proficiency data

/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-11-01T17:30:24.235000
    - Additional Notes: Query prioritizes counties based on both overall SVI scores and minority population percentages. Thresholds (25% for most racial groups, 15% for Asian, 10% for Native American) were chosen based on typical demographic distributions but may need adjustment for specific use cases. The 'High Priority' designation requires both high vulnerability (top quartile) and majority-minority population.
    
    */