
/*******************************************************************************
Title: Social Vulnerability Index Analysis by State and Theme - 2018

Business Purpose:
This query analyzes the Social Vulnerability Index (SVI) data at the state level 
to identify areas with the highest social vulnerability across different themes:
- Socioeconomic Status (Theme 1)
- Household Composition (Theme 2) 
- Minority Status/Language (Theme 3)
- Housing Type/Transportation (Theme 4)

This helps policymakers and emergency planners:
1. Identify states with concentrated social vulnerability
2. Understand which specific vulnerability factors are most prevalent
3. Target resources and support to the most vulnerable populations
*******************************************************************************/

WITH state_metrics AS (
  -- Calculate average theme rankings and overall SVI for each state
  SELECT 
    state,
    COUNT(*) as census_tracts,
    ROUND(AVG(rpl_theme1),3) as avg_socioeconomic_rank,
    ROUND(AVG(rpl_theme2),3) as avg_household_comp_rank, 
    ROUND(AVG(rpl_theme3),3) as avg_minority_lang_rank,
    ROUND(AVG(rpl_theme4),3) as avg_housing_trans_rank,
    ROUND(AVG(rpl_themes),3) as avg_overall_svi,
    
    -- Calculate percentage of tracts with high vulnerability flags
    ROUND(AVG(CASE WHEN f_theme1 >= 1 THEN 1 ELSE 0 END)*100,1) as pct_high_socioeconomic,
    ROUND(AVG(CASE WHEN f_theme2 >= 1 THEN 1 ELSE 0 END)*100,1) as pct_high_household,
    ROUND(AVG(CASE WHEN f_theme3 >= 1 THEN 1 ELSE 0 END)*100,1) as pct_high_minority,
    ROUND(AVG(CASE WHEN f_theme4 >= 1 THEN 1 ELSE 0 END)*100,1) as pct_high_housing
  FROM mimi_ws_1.cdc.svi_censustract_y2018
  GROUP BY state
)

SELECT
  state,
  census_tracts,
  avg_overall_svi,
  
  -- Show theme rankings
  avg_socioeconomic_rank,
  avg_household_comp_rank,
  avg_minority_lang_rank, 
  avg_housing_trans_rank,
  
  -- Show percentage of high vulnerability tracts
  pct_high_socioeconomic,
  pct_high_household,
  pct_high_minority,
  pct_high_housing
FROM state_metrics
ORDER BY avg_overall_svi DESC;

/*******************************************************************************
How this query works:
1. Calculates state-level averages for each SVI theme ranking
2. Determines percentage of census tracts with high vulnerability flags
3. Orders results by overall SVI to highlight most vulnerable states

Assumptions and Limitations:
- Uses simple averages which may mask within-state variations
- High vulnerability based on having at least 1 flag in a theme
- Does not account for population differences between tracts
- 2018 data may not reflect current conditions

Possible Extensions:
1. Add population-weighted averages
2. Include year-over-year trend analysis
3. Add county-level breakdowns within states
4. Incorporate specific factors like poverty or disability rates
5. Create vulnerability categories (High/Medium/Low) based on percentiles
*******************************************************************************/
/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-10-28T15:04:44.683839
    - Additional Notes: The query aggregates census tract-level CDC Social Vulnerability Index data to provide state-level insights. It focuses on the four main vulnerability themes and provides both average rankings and percentages of high-vulnerability tracts. Results are ordered by overall vulnerability to highlight states needing the most attention. Note that simple averages are used and may not fully represent population-weighted vulnerability.
    
    */