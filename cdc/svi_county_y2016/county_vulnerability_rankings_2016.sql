
/*******************************************************************************
Title: Core Social Vulnerability Analysis by County and State for 2016

Business Purpose:
This query analyzes Social Vulnerability Index (SVI) data at the county level to:
- Identify most vulnerable counties based on key SVI themes
- Compare vulnerability across states 
- Support disaster preparedness and public health planning
- Help target resources to communities most in need

Key themes analyzed:
1. Socioeconomic Status
2. Household Composition 
3. Minority Status/Language
4. Housing Type/Transportation
*******************************************************************************/

WITH ranked_counties AS (
  SELECT 
    state,
    county,
    e_totpop,
    -- Overall vulnerability score and ranking
    rpl_themes as overall_vulnerability_percentile,
    
    -- Theme-specific percentile rankings
    rpl_theme1 as socioeconomic_percentile,
    rpl_theme2 as household_comp_percentile, 
    rpl_theme3 as minority_lang_percentile,
    rpl_theme4 as housing_trans_percentile,
    
    -- Key vulnerability flags (1 = high vulnerability)
    f_pov as high_poverty_flag,
    f_unemp as high_unemployment_flag,
    f_disabl as high_disability_flag,
    f_noveh as no_vehicle_flag,
    
    -- Rank counties within each state by overall vulnerability
    ROW_NUMBER() OVER (PARTITION BY state ORDER BY rpl_themes DESC) as vulnerability_rank_in_state
    
  FROM mimi_ws_1.cdc.svi_county_y2016
)

-- Get top 5 most vulnerable counties for each state
SELECT
  state,
  county,
  e_totpop as population,
  ROUND(overall_vulnerability_percentile, 2) as overall_vulnerability_pct,
  ROUND(socioeconomic_percentile, 2) as socioeconomic_pct,
  ROUND(household_comp_percentile, 2) as household_pct,
  ROUND(minority_lang_percentile, 2) as minority_lang_pct, 
  ROUND(housing_trans_percentile, 2) as housing_trans_pct,
  
  -- Flag if county has multiple high vulnerability indicators
  (high_poverty_flag + high_unemployment_flag + high_disability_flag + no_vehicle_flag) as total_high_risk_flags
  
FROM ranked_counties
WHERE vulnerability_rank_in_state <= 5
ORDER BY state, vulnerability_rank_in_state;

/*******************************************************************************
How this query works:
1. CTE ranks counties within each state by overall vulnerability score
2. Main query selects top 5 most vulnerable counties per state
3. Includes key theme percentiles and counts high risk flags
4. Results ordered by state and vulnerability rank

Assumptions & Limitations:
- Uses 2016 data only - trends over time not captured
- Equal weighting given to all vulnerability themes
- Top 5 counties may not capture all high-risk areas in large states
- Some small counties may have data quality issues

Possible Extensions:
1. Add year-over-year comparison when using multiyear data
2. Weight themes differently based on specific disaster scenarios
3. Add geographic clustering analysis
4. Include additional demographic or health outcome data
5. Create vulnerability threshold alerts
6. Add visualization components
*******************************************************************************/
/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-10-28T14:35:52.814039
    - Additional Notes: The query focuses on county-level social vulnerability rankings and flags, particularly useful for disaster preparedness planning and resource allocation. Note that the percentile calculations (0-1 scale) are left as decimals to allow for flexible formatting in downstream applications.
    
    */