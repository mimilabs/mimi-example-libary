
/*******************************************************************************
Title: Social Vulnerability Index Analysis Across Time and Regions
 
Business Purpose:
This query analyzes trends in social vulnerability across different states and years,
highlighting areas that may need the most support during disasters. It helps
decision makers identify:
- Which states have the highest social vulnerability 
- How vulnerability patterns have changed over time
- Which dimensions of vulnerability are most significant

This information is crucial for:
- Disaster preparedness and response planning
- Resource allocation
- Policy development
*******************************************************************************/

WITH state_yearly_averages AS (
    -- Calculate average vulnerability scores by state and year
    SELECT 
        state_abbr,
        year,
        AVG(svi) as avg_total_svi,
        AVG(rpl_socioeconomic) as avg_socioeconomic,
        AVG(rpl_householdcomp) as avg_household,
        AVG(rpl_minoritystatus) as avg_minority,
        AVG(rpl_housingtransport) as avg_housing
    FROM mimi_ws_1.cdc.svi_censustract_multiyears
    WHERE svi IS NOT NULL
    GROUP BY state_abbr, year
)

SELECT 
    state_abbr,
    year,
    -- Round averages to 3 decimal places for readability
    ROUND(avg_total_svi, 3) as avg_total_svi,
    ROUND(avg_socioeconomic, 3) as avg_socioeconomic,
    ROUND(avg_household, 3) as avg_household,
    ROUND(avg_minority, 3) as avg_minority,
    ROUND(avg_housing, 3) as avg_housing,
    -- Identify the highest vulnerability factor for each state-year
    CASE 
        WHEN avg_socioeconomic >= GREATEST(avg_household, avg_minority, avg_housing) 
        THEN 'Socioeconomic'
        WHEN avg_household >= GREATEST(avg_socioeconomic, avg_minority, avg_housing) 
        THEN 'Household Composition'
        WHEN avg_minority >= GREATEST(avg_socioeconomic, avg_household, avg_housing) 
        THEN 'Minority Status'
        ELSE 'Housing/Transportation'
    END as highest_vulnerability_factor
FROM state_yearly_averages
ORDER BY avg_total_svi DESC, year DESC;

/*******************************************************************************
How it works:
1. Creates a CTE to calculate average vulnerability scores by state and year
2. Main query formats results and identifies the highest vulnerability factor
3. Orders results to show highest vulnerability areas first

Assumptions & Limitations:
- Assumes NULL values should be excluded from averages
- Uses simple averaging which may mask extreme values
- State-level aggregation loses granular census tract insights

Possible Extensions:
1. Add year-over-year change calculations to identify trending vulnerabilities
2. Include county-level analysis for more granular insights
3. Add filters for specific states or date ranges
4. Calculate population-weighted averages instead of simple averages
5. Add statistical significance tests for temporal changes
*******************************************************************************/
/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-10-28T15:10:23.528002
    - Additional Notes: Query aggregates at state level which may mask important local variations. Consider adding population weighting for more accurate vulnerability assessment. Performance may be impacted when analyzing multiple years of data simultaneously.
    
    */