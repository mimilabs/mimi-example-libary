-- high_vulnerability_hotspots.sql

-- Business Purpose:
-- Identifies census tracts that consistently show high vulnerability across multiple domains,
-- helping healthcare organizations prioritize resource allocation and community outreach.
-- These "hotspots" may require targeted interventions and enhanced disaster preparedness.

WITH RankedTracts AS (
    -- Identify census tracts with consistently high vulnerability scores
    -- High vulnerability defined as being in the top quartile (>= 0.75) across domains
    SELECT 
        state_abbr,
        county_name,
        fips,
        year,
        CASE WHEN 
            rpl_socioeconomic >= 0.75 AND 
            rpl_householdcomp >= 0.75 AND
            rpl_minoritystatus >= 0.75 AND
            rpl_housingtransport >= 0.75
        THEN 1 ELSE 0 END as high_risk_flag,
        svi as total_vulnerability
    FROM mimi_ws_1.cdc.svi_censustract_multiyears
    WHERE YEAR(year) >= 2018  -- Convert date to year and compare
),

HotspotSummary AS (
    -- Aggregate to identify persistent hotspots
    SELECT 
        state_abbr,
        county_name,
        COUNT(DISTINCT fips) as total_tracts,
        SUM(high_risk_flag) as high_risk_tracts,
        ROUND(AVG(total_vulnerability), 3) as avg_vulnerability
    FROM RankedTracts
    GROUP BY state_abbr, county_name
    HAVING COUNT(DISTINCT fips) >= 5  -- Filter for areas with meaningful sample size
)

SELECT 
    state_abbr,
    county_name,
    total_tracts,
    high_risk_tracts,
    ROUND(100.0 * high_risk_tracts / total_tracts, 1) as pct_high_risk,
    avg_vulnerability
FROM HotspotSummary
WHERE high_risk_tracts > 0
ORDER BY pct_high_risk DESC, total_tracts DESC
LIMIT 20;

-- How it works:
-- 1. First CTE identifies census tracts with high vulnerability across all domains
-- 2. Second CTE aggregates results to county level
-- 3. Final query calculates percentage of high-risk tracts and sorts to show most critical areas

-- Assumptions and Limitations:
-- - Uses 0.75 as threshold for "high vulnerability" - may need adjustment based on specific needs
-- - Focuses on recent years (2018+) assuming more relevant for current planning
-- - Requires at least 5 census tracts in a county to be included
-- - Equal weighting given to all vulnerability domains
-- - Assumes 'year' column is in DATE format

-- Possible Extensions:
-- 1. Add year-over-year trend analysis to identify emerging hotspots
-- 2. Include population data to weight results by population size
-- 3. Create risk tiers based on different vulnerability thresholds
-- 4. Add geographic clustering analysis to identify regional patterns
-- 5. Compare against local healthcare facility capacity data

/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-11-01T17:56:53.583125
    - Additional Notes: Query identifies counties with concentrated social vulnerability by analyzing census tracts that score high across all SVI domains. Results are weighted towards areas with multiple high-risk tracts, making it particularly useful for regional healthcare planning and resource allocation. The 0.75 threshold for high vulnerability can be adjusted based on specific program needs.
    
    */