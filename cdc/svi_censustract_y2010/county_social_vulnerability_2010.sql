
/*******************************************************************************
Title: Social Vulnerability Analysis by Census Tract (2010)
  
Business Purpose:
This query analyzes the Social Vulnerability Index (SVI) components at the census 
tract level to identify areas with high vulnerability across different dimensions.
This information helps emergency planners and public health officials:
- Target resources to communities that need the most support
- Plan emergency response and disaster recovery
- Identify areas needing special attention during crises
*******************************************************************************/

WITH vulnerability_metrics AS (
  SELECT 
    state_name,
    county,
    -- Overall vulnerability ranking (0-1 scale)
    r_pl_themes as overall_vulnerability,
    
    -- Theme-specific vulnerability rankings
    r_pl_theme1 as socioeconomic_vulnerability,
    r_pl_theme2 as household_composition_vulnerability, 
    r_pl_theme3 as minority_language_vulnerability,
    r_pl_theme4 as housing_transport_vulnerability,
    
    -- Key demographic indicators
    totpop as total_population,
    e_p_pov as poverty_rate,
    e_p_unemp as unemployment_rate,
    p_minority as minority_percentage,
    e_p_noveh as no_vehicle_percentage
  FROM mimi_ws_1.cdc.svi_censustract_y2010
  WHERE totpop > 0  -- Exclude unpopulated tracts
)

SELECT
  state_name,
  county,
  COUNT(*) as num_tracts,
  
  -- Average vulnerability scores (0-1 scale where 1 is most vulnerable)
  ROUND(AVG(overall_vulnerability), 3) as avg_overall_vulnerability,
  ROUND(AVG(socioeconomic_vulnerability), 3) as avg_socioeconomic_vulnerability,
  ROUND(AVG(household_composition_vulnerability), 3) as avg_household_vulnerability,
  ROUND(AVG(minority_language_vulnerability), 3) as avg_minority_vulnerability,
  ROUND(AVG(housing_transport_vulnerability), 3) as avg_housing_vulnerability,
  
  -- Population statistics
  SUM(total_population) as total_county_population,
  
  -- Key risk indicators
  ROUND(AVG(poverty_rate) * 100, 1) as avg_poverty_rate_pct,
  ROUND(AVG(unemployment_rate) * 100, 1) as avg_unemployment_rate_pct,
  ROUND(AVG(minority_percentage) * 100, 1) as avg_minority_pct,
  ROUND(AVG(no_vehicle_percentage) * 100, 1) as avg_no_vehicle_pct

FROM vulnerability_metrics
GROUP BY state_name, county
HAVING num_tracts >= 5  -- Focus on counties with sufficient data
ORDER BY avg_overall_vulnerability DESC
LIMIT 20;

/*******************************************************************************
How this query works:
1. Creates a CTE to extract key vulnerability metrics and demographics
2. Aggregates data at county level, calculating average vulnerability scores
3. Includes population statistics and key risk indicators
4. Filters for counties with at least 5 census tracts
5. Orders by overall vulnerability to show most vulnerable counties first

Assumptions and Limitations:
- Assumes populated census tracts provide more reliable data
- Limited to 2010 data snapshot
- County-level averages may mask significant within-county variation
- Results biased toward counties with more census tracts due to filtering

Possible Extensions:
1. Add geographic analysis to identify clusters of vulnerable areas
2. Compare rural vs urban vulnerability patterns
3. Correlate with disaster impact data
4. Add year-over-year comparison when using multi-year data
5. Include additional demographic or economic indicators
*******************************************************************************/
/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-10-28T14:50:13.674637
    - Additional Notes: This query aggregates census tract-level SVI data to county level, focusing on counties with 5+ tracts. The results show the top 20 most vulnerable counties based on overall SVI scores, along with detailed vulnerability metrics across different themes (socioeconomic, household composition, minority status, and housing/transportation). Population thresholds and tract count requirements may need adjustment based on specific analysis needs.
    
    */