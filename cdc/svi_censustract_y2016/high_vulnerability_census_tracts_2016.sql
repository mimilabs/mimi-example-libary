
/*******************************************************************************
Title: Social Vulnerability Analysis by Census Tract - 2016
 
Business Purpose:
This query analyzes social vulnerability across census tracts to identify areas 
that may need additional support during disasters or emergencies. It examines key
vulnerability indicators and overall rankings to help prioritize resource allocation
and emergency planning.

Key metrics analyzed:
- Overall social vulnerability ranking
- Socioeconomic vulnerability 
- Household composition vulnerability
- Minority status/language vulnerability
- Housing/transportation vulnerability
*******************************************************************************/

WITH ranked_tracts AS (
  -- Calculate key metrics and rank census tracts
  SELECT 
    state,
    county,
    location,
    e_totpop as total_population,
    
    -- Overall vulnerability score (0-1 scale)
    rpl_themes as overall_vulnerability_percentile,
    
    -- Theme-specific vulnerability scores
    rpl_theme1 as socioeconomic_percentile,
    rpl_theme2 as household_comp_percentile, 
    rpl_theme3 as minority_lang_percentile,
    rpl_theme4 as housing_trans_percentile,
    
    -- Key contributing factors
    ep_pov as poverty_pct,
    ep_unemp as unemployment_pct,
    ep_nohsdp as no_highschool_pct,
    ep_noveh as no_vehicle_pct,
    ep_minrty as minority_pct,
    ep_limeng as limited_english_pct
    
  FROM mimi_ws_1.cdc.svi_censustract_y2016
  WHERE e_totpop > 0  -- Exclude unpopulated tracts
)

SELECT
  state,
  county,
  location,
  total_population,
  
  -- Round percentiles to 2 decimal places
  ROUND(overall_vulnerability_percentile, 2) as overall_vulnerability_percentile,
  ROUND(socioeconomic_percentile, 2) as socioeconomic_percentile,
  ROUND(household_comp_percentile, 2) as household_comp_percentile,
  ROUND(minority_lang_percentile, 2) as minority_lang_percentile, 
  ROUND(housing_trans_percentile, 2) as housing_trans_percentile,
  
  -- Round percentages to 1 decimal place
  ROUND(poverty_pct, 1) as poverty_pct,
  ROUND(unemployment_pct, 1) as unemployment_pct,
  ROUND(no_highschool_pct, 1) as no_highschool_pct,
  ROUND(no_vehicle_pct, 1) as no_vehicle_pct,
  ROUND(minority_pct, 1) as minority_pct,
  ROUND(limited_english_pct, 1) as limited_english_pct

FROM ranked_tracts

-- Focus on most vulnerable areas
WHERE overall_vulnerability_percentile >= 0.9

-- Order by vulnerability score
ORDER BY overall_vulnerability_percentile DESC
LIMIT 100;

/*******************************************************************************
How this query works:
1. Extracts key vulnerability metrics from the source table
2. Calculates percentile rankings for overall and theme-specific vulnerability
3. Identifies the most vulnerable census tracts (top 10th percentile)
4. Shows contributing factors to help understand drivers of vulnerability

Assumptions and limitations:
- Uses 2016 data only - may not reflect current conditions
- Focus on highest vulnerability areas only (>=90th percentile)
- Assumes populated census tracts only
- Does not account for geographic clustering of vulnerability

Possible extensions:
1. Add geographic analysis to identify clusters of vulnerable areas
2. Compare vulnerability across urban vs rural areas
3. Analyze specific themes or factors in more detail
4. Add trend analysis using data from multiple years
5. Include additional demographic or economic variables
6. Create vulnerability indices for specific types of emergencies
*******************************************************************************/
/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-10-28T14:29:15.388832
    - Additional Notes: Query focuses on top 100 most vulnerable census tracts based on CDC's Social Vulnerability Index. The 0.9 threshold for overall_vulnerability_percentile can be adjusted to analyze different vulnerability levels. Population filter (e_totpop > 0) ensures meaningful results by excluding unpopulated areas.
    
    */