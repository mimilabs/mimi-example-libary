-- Title: Healthcare Access and Social Determinants Risk Analysis
-- Business Purpose:
-- - Identify ZIP codes with high-risk combinations of healthcare access barriers and social determinants
-- - Support targeted intervention planning by highlighting areas where multiple risk factors intersect
-- - Enable resource allocation decisions based on comprehensive vulnerability assessment
-- - Facilitate community health needs assessments for healthcare organizations

WITH risk_factors AS (
  SELECT 
    zip_code,
    state,
    population_size,
    zcta_uns,
    -- Create normalized risk scores (0-1 scale) for key access barriers
    CASE WHEN uninsured > 0.25 THEN 1 ELSE uninsured END as insurance_risk,
    CASE WHEN health_center_penetration < 0.4 THEN 1 ELSE 0 END as access_risk,
    CASE WHEN no_vehicle_access > 0.15 THEN 1 ELSE 0 END as transport_risk,
    
    -- Create normalized risk scores for social determinants
    CASE WHEN below_poverty_level > 0.20 THEN 1 ELSE 0 END as poverty_risk,
    CASE WHEN linguistic_isolation > 0.10 THEN 1 ELSE 0 END as language_risk,
    CASE WHEN housing_stress > 0.30 THEN 1 ELSE 0 END as housing_risk
  FROM mimi_ws_1.hrsa.unmet_need_score
  WHERE population_size >= 1000 -- Focus on areas with meaningful population size
)

SELECT
  zip_code,
  state,
  population_size,
  zcta_uns as unmet_need_score,
  
  -- Calculate composite risk score
  (insurance_risk + access_risk + transport_risk + 
   poverty_risk + language_risk + housing_risk) as total_risk_factors,
   
  -- Flag high-priority areas
  CASE 
    WHEN (insurance_risk + access_risk + transport_risk + 
          poverty_risk + language_risk + housing_risk) >= 4 
    THEN 'High Priority'
    WHEN (insurance_risk + access_risk + transport_risk + 
          poverty_risk + language_risk + housing_risk) >= 2 
    THEN 'Medium Priority'
    ELSE 'Lower Priority'
  END as intervention_priority

FROM risk_factors

-- Focus on areas with multiple overlapping risks
WHERE (insurance_risk + access_risk + transport_risk + 
       poverty_risk + language_risk + housing_risk) >= 2

ORDER BY total_risk_factors DESC, population_size DESC

LIMIT 1000;

-- How the Query Works:
-- 1. Creates normalized risk scores for key healthcare access barriers and social determinants
-- 2. Combines risks into a composite score while maintaining individual factor visibility
-- 3. Prioritizes areas based on number of overlapping risk factors
-- 4. Filters for meaningful population size and multiple risks present

-- Assumptions and Limitations:
-- - Equal weighting of risk factors (could be adjusted based on local priorities)
-- - Binary risk thresholds (could be made more granular)
-- - Current year data (temporal trends not considered)
-- - Population size threshold of 1000 (may need adjustment for rural areas)

-- Possible Extensions:
-- 1. Add health outcome metrics (mortality, chronic disease) for impact assessment
-- 2. Include temporal analysis to track changes in risk profiles
-- 3. Create geographic clusters of high-risk areas
-- 4. Add demographic breakdowns within high-risk areas
-- 5. Calculate potential intervention impact based on population reached

/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-10-31T18:29:25.800801
    - Additional Notes: The query creates a composite vulnerability score using multiple social and healthcare access risk factors. The risk thresholds (e.g., 0.25 for uninsured, 0.4 for health center penetration) should be validated against local standards and adjusted as needed. The population size threshold of 1000 may need adjustment for rural areas.
    
    */