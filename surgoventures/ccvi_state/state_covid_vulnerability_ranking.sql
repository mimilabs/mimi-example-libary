
/* 
COVID-19 Community Vulnerability Analysis by State

Business Purpose:
This query analyzes state-level COVID-19 vulnerability using the CCVI (COVID-19 Community 
Vulnerability Index) to identify the most vulnerable states and their key risk factors.
This helps decision makers prioritize resources and interventions where they are most needed.
*/

-- Main query to analyze state vulnerability scores and rankings
WITH state_rankings AS (
  SELECT 
    state_name,
    ccvi,
    -- Calculate rankings for overall CCVI and key themes
    RANK() OVER (ORDER BY ccvi DESC) as vulnerability_rank,
    theme1,
    theme2,
    theme3,
    theme4,
    theme5,
    -- Identify highest risk theme using GREATEST function
    GREATEST(theme1, theme2, theme3, theme4, theme5) as highest_risk_score,
    -- Determine primary vulnerability factor
    CASE 
      WHEN theme1 >= theme2 AND theme1 >= theme3 AND theme1 >= theme4 AND theme1 >= theme5 
        THEN 'Socioeconomic Status'
      WHEN theme2 >= theme1 AND theme2 >= theme3 AND theme2 >= theme4 AND theme2 >= theme5
        THEN 'Minority Status & Language'
      WHEN theme3 >= theme1 AND theme3 >= theme2 AND theme3 >= theme4 AND theme3 >= theme5
        THEN 'Housing & Transportation'
      WHEN theme4 >= theme1 AND theme4 >= theme2 AND theme4 >= theme3 AND theme4 >= theme5
        THEN 'Epidemiological Factors'
      ELSE 'Healthcare System Factors'
    END as primary_vulnerability_factor
  FROM mimi_ws_1.surgoventures.ccvi_state
)

SELECT
  state_name,
  ROUND(ccvi, 3) as vulnerability_score,
  vulnerability_rank,
  ROUND(highest_risk_score, 3) as highest_risk_score,
  primary_vulnerability_factor
FROM state_rankings
ORDER BY vulnerability_rank
LIMIT 10; -- Show top 10 most vulnerable states

/*
How this query works:
1. Creates a CTE to calculate state rankings based on CCVI scores
2. Identifies the highest risk score among the vulnerability themes for each state
3. Determines the primary vulnerability factor based on which theme has the highest score
4. Returns top 10 most vulnerable states with their scores and primary risk factors

Assumptions and Limitations:
- Assumes CCVI scores are up to date and complete for all states
- Equal weighting given to all vulnerability themes when determining primary factor
- Focus is on top-level state analysis rather than county-level details
- Limited to showing only top 10 states but could be modified

Possible Extensions:
1. Add regional grouping to identify geographic patterns
2. Include year-over-year trend analysis if historical data available
3. Correlate with actual COVID-19 outcomes (cases, deaths, etc.)
4. Add demographic factors to provide additional context
5. Expand to include county-level analysis within high-risk states
6. Calculate vulnerability scores weighted by population
7. Add visualization capabilities for geographic distribution of risk
*/
/*

    - Author: claude-3-5-sonnet-20241022
    - Created At: 2024-10-28T16:05:47.482425
    - Additional Notes: Query shows top 10 most vulnerable states based on CCVI scores and identifies their primary vulnerability factors. The results are sorted by overall vulnerability rank and include rounded scores for better readability. Theme scores (1-5) represent different aspects of vulnerability: socioeconomic status, minority status & language, housing & transportation, epidemiological factors, and healthcare system factors.
    
    */